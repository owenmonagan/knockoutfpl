# Auto-Commit After Passing Tests

This project is configured to automatically create git commits whenever all tests pass.

## How It Works

The auto-commit system uses a **hybrid approach** with two triggers:

### 1. PostToolUse Hook (Claude Code Integration)
- Triggers when Claude runs tests via the `Bash` tool
- Configured in `.claude/settings.json`
- Executes `.claude/hooks/post-test-commit.sh` after test completion

### 2. Watchman File Watcher (Manual Test Runs)
- Monitors `.claude/tdd-guard/data/test.json` for changes
- Triggers when you manually run `npm test`
- Runs the same commit script automatically

## Setup

The system is already configured and ready to use. If you need to reconfigure:

```bash
# Re-initialize Watchman trigger
./.claude/hooks/setup-watchman.sh
```

## Behavior

The auto-commit script (`post-test-commit.sh`) will:

✅ **Create a commit when:**
- All tests pass (reason: "passed" in test.json)
- No test failures detected
- Git working directory has changes

❌ **Skip committing when:**
- Any test fails
- No tests found
- No changes in git working directory
- Test results file doesn't exist

## Commit Message Format

Commits are created with this format:

```
✅ Tests passing: X tests green

Auto-committed after successful test run
- X tests passed
- 0 tests failed
- Timestamp: YYYY-MM-DD HH:MM:SS
```

## Testing the Feature

To verify auto-commit is working:

1. Make a code change
2. Run tests: `npm test -- --run`
3. If all tests pass, a commit is automatically created
4. Check git log: `git log -1`

## Manual Testing

You can manually trigger the commit script:

```bash
PROJECT_DIR=/Users/owen/work/knockoutfpl ./.claude/hooks/post-test-commit.sh
```

## Disabling Auto-Commit

### Temporarily Disable

Remove the Watchman trigger:
```bash
watchman trigger-del /Users/owen/work/knockoutfpl auto-commit-tests
```

Remove the PostToolUse hook from `.claude/settings.json`:
```json
{
  "hooks": {
    "PostToolUse": []  // Remove the Bash matcher
  }
}
```

### Permanently Disable

Delete the hook files:
```bash
rm ./.claude/hooks/post-test-commit.sh
rm ./.claude/hooks/setup-watchman.sh
```

## Troubleshooting

### Auto-commit not triggering

1. Check Watchman is running:
   ```bash
   watchman trigger-list /Users/owen/work/knockoutfpl
   ```

2. Verify test.json is being created:
   ```bash
   ls -la .claude/tdd-guard/data/test.json
   ```

3. Check hook script is executable:
   ```bash
   ls -l .claude/hooks/post-test-commit.sh
   ```

### Verify test results

Check what the script sees:
```bash
cat .claude/tdd-guard/data/test.json | python3 -m json.tool
```

## Architecture

```
┌─────────────────────────┐
│  Test Run Triggers      │
├─────────────────────────┤
│ 1. Claude runs tests    │  →  PostToolUse Hook
│ 2. Manual npm test      │  →  Watchman Trigger
└─────────────────────────┘
           ↓
┌─────────────────────────┐
│  TDD Guard Vitest       │
│  Reporter               │
└─────────────────────────┘
           ↓
    test.json updated
           ↓
┌─────────────────────────┐
│  post-test-commit.sh    │
├─────────────────────────┤
│ 1. Parse test results   │
│ 2. Check all passed     │
│ 3. Stage changes        │
│ 4. Create commit        │
└─────────────────────────┘
```

## Benefits

- ✅ Never forget to commit after passing tests
- ✅ Creates granular commit history aligned with TDD cycle
- ✅ Works with both Claude and manual workflows
- ✅ Self-documenting commits with test counts
- ✅ Integrates seamlessly with TDD Guard

## Files

- `.claude/hooks/post-test-commit.sh` - Main auto-commit logic
- `.claude/hooks/setup-watchman.sh` - Watchman initialization
- `.claude/settings.json` - Claude Code hook configuration
- `.claude/tdd-guard/data/test.json` - Test results (generated by TDD Guard)
