rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);

      // Users can create their own profile on signup
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasAll(['userId', 'fplTeamId', 'fplTeamName', 'email', 'displayName', 'wins', 'losses', 'createdAt', 'updatedAt'])
        && request.resource.data.userId == userId;

      // Users can update their own profile (except userId)
      allow update: if isOwner(userId)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['userId']);
    }

    // Challenges collection
    match /challenges/{challengeId} {
      // Users can read challenges they're part of
      allow read: if isAuthenticated()
        && (resource.data.creatorUserId == request.auth.uid
            || resource.data.opponentUserId == request.auth.uid);

      // Users can create challenges
      allow create: if isAuthenticated()
        && request.resource.data.creatorUserId == request.auth.uid
        && request.resource.data.status == 'pending'
        && request.resource.data.opponentUserId == null;

      // Only opponent can accept a pending challenge
      allow update: if isAuthenticated()
        && resource.data.status == 'pending'
        && request.resource.data.opponentUserId == request.auth.uid
        && request.resource.data.status == 'accepted'
        // Ensure only opponent fields are updated
        && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['opponentUserId', 'opponentFplId', 'opponentFplTeamName', 'status']);

      // Note: Score updates and completion are handled by Cloud Functions only
      // No client-side updates allowed for scores/completion
    }
  }
}
