# Knockout FPL Queries
# Using filter-based lookups for custom-keyed tables

# =============================================================================
# USER QUERIES
# =============================================================================

# Get current user by Firebase UID
query GetUser($uid: String!) @auth(level: USER) {
  users(where: { uid: { eq: $uid } }, limit: 1) {
    uid
    email
    entryId2025
    createdAt
    updatedAt
  }
}

# =============================================================================
# ENTRY QUERIES (FPL Team Data)
# =============================================================================

# Get entry by ID
query GetEntry($entryId: Int!) @auth(level: PUBLIC) {
  entries(where: { entryId: { eq: $entryId } }, limit: 1) {
    entryId
    season
    name
    playerFirstName
    playerLastName
    summaryOverallPoints
    summaryOverallRank
    summaryEventPoints
    summaryEventRank
    rawJson
    cachedAt
  }
}

# Get multiple entries by IDs
query GetEntries($entryIds: [Int!]!) @auth(level: PUBLIC) {
  entries(where: { entryId: { in: $entryIds } }) {
    entryId
    season
    name
    playerFirstName
    playerLastName
    summaryOverallPoints
    summaryOverallRank
    cachedAt
  }
}

# =============================================================================
# PICKS QUERIES
# =============================================================================

# Get picks for an entry and event
query GetPick($entryId: Int!, $event: Int!) @auth(level: PUBLIC) {
  picks(where: { entryId: { eq: $entryId }, event: { eq: $event } }, limit: 1) {
    entryId
    event
    points
    totalPoints
    rank
    overallRank
    activeChip
    isFinal
    rawJson
    cachedAt
  }
}

# Get picks for specific entries in an event (includes provisional scores during live gameweeks)
query GetPicksForEvent($event: Int!, $entryIds: [Int!]!) @auth(level: PUBLIC) {
  picks(where: { event: { eq: $event }, entryId: { in: $entryIds } }) {
    entryId
    event
    points
    totalPoints
    rank
    isFinal
  }
}

# =============================================================================
# LEAGUE QUERIES
# =============================================================================

# Get league by ID and season
query GetLeague($leagueId: Int!, $season: String!) @auth(level: PUBLIC) {
  leagues(where: { leagueId: { eq: $leagueId }, season: { eq: $season } }, limit: 1) {
    leagueId
    season
    name
    created
    adminEntry
    rawJson
    cachedAt
  }
}

# =============================================================================
# LEAGUE ENTRY QUERIES
# =============================================================================

# Check if league needs refresh (compare entriesCount, check lastRefreshAt)
query GetLeagueRefreshStatus($leagueId: Int!, $season: String!) @auth(level: PUBLIC) {
  leagues(where: { leagueId: { eq: $leagueId }, season: { eq: $season } }, limit: 1) {
    leagueId
    name
    entriesCount
    lastRefreshId
    lastRefreshAt
  }
}

# Get all entries for a league (to compare with FPL API data)
query GetLeagueEntries($leagueId: Int!, $season: String!) @auth(level: PUBLIC) {
  leagueEntries(
    where: { leagueId: { eq: $leagueId }, season: { eq: $season } }
    orderBy: { rank: ASC }
  ) {
    entryId
    rank
    refreshId
    entry {
      name
      playerFirstName
      playerLastName
    }
  }
}

# =============================================================================
# EVENT QUERIES
# =============================================================================

# Get current event
query GetCurrentEvent($season: String!) @auth(level: PUBLIC) {
  events(where: { season: { eq: $season }, isCurrent: { eq: true } }, limit: 1) {
    event
    season
    name
    deadlineTime
    finished
    isCurrent
    isNext
  }
}

# Get event by number
query GetEvent($event: Int!, $season: String!) @auth(level: PUBLIC) {
  events(where: { event: { eq: $event }, season: { eq: $season } }, limit: 1) {
    event
    season
    name
    deadlineTime
    finished
    isCurrent
    isNext
    rawJson
    cachedAt
  }
}

# Get all events for a season
query GetSeasonEvents($season: String!) @auth(level: PUBLIC) {
  events(where: { season: { eq: $season } }, orderBy: { event: ASC }) {
    event
    season
    name
    deadlineTime
    finished
    isCurrent
    isNext
  }
}

# Get events that are finished but not yet finalized (need to check /event-status/)
query GetEventsNeedingFinalization($season: String!) @auth(level: PUBLIC) {
  events(
    where: {
      season: { eq: $season }
      finished: { eq: true }
      finalizedAt: { isNull: true }
    }
  ) {
    event
    season
    name
    finished
    finalizedAt
    deadlineTime
    rawJson
    isCurrent
    isNext
  }
}

# Get events that have been finalized (scores are final)
query GetFinalizedEvents($season: String!) @auth(level: PUBLIC) {
  events(
    where: {
      season: { eq: $season }
      finalizedAt: { isNull: false }
    }
    orderBy: { event: DESC }
  ) {
    event
    season
    name
    finished
    finalizedAt
  }
}

# Get event finalization status for a specific gameweek
query GetEventFinalization($event: Int!, $season: String!) @auth(level: PUBLIC) {
  events(
    where: { event: { eq: $event }, season: { eq: $season } }
    limit: 1
  ) {
    event
    season
    finished
    finalizedAt
  }
}

# =============================================================================
# TOURNAMENT QUERIES
# =============================================================================

# Get tournament by ID (basic)
query GetTournament($id: UUID!) @auth(level: PUBLIC) {
  tournament(id: $id) {
    id
    fplLeagueId
    fplLeagueName
    creatorUid
    participantCount
    totalRounds
    currentRound
    startEvent
    seedingMethod
    matchSize
    status
    winnerEntryId
    createdAt
    updatedAt
    creator {
      uid
      email
    }
  }
}

# Get tournament with participants
query GetTournamentWithParticipants($id: UUID!, $participantLimit: Int = 10000) @auth(level: PUBLIC) {
  tournament(id: $id) {
    id
    fplLeagueId
    fplLeagueName
    participantCount
    totalRounds
    currentRound
    startEvent
    seedingMethod
    matchSize
    status
    winnerEntryId
  }
  participants(where: { tournamentId: { eq: $id } }, orderBy: { seed: ASC }, limit: $participantLimit) {
    tournamentId
    entryId
    teamName
    managerName
    seed
    leagueRank
    leaguePoints
    status
    eliminationRound
    uid
  }
}

# Get tournaments created by user
query GetUserTournaments($creatorUid: String!) @auth(level: USER) {
  tournaments(where: { creatorUid: { eq: $creatorUid } }, orderBy: { createdAt: DESC }) {
    id
    fplLeagueId
    fplLeagueName
    participantCount
    totalRounds
    currentRound
    startEvent
    seedingMethod
    matchSize
    status
    createdAt
  }
}

# Get tournaments for an FPL league
query GetLeagueTournaments($fplLeagueId: Int!) @auth(level: PUBLIC) {
  tournaments(where: { fplLeagueId: { eq: $fplLeagueId } }, orderBy: { createdAt: DESC }) {
    id
    fplLeagueName
    participantCount
    totalRounds
    currentRound
    startEvent
    seedingMethod
    matchSize
    status
    createdAt
    creatorUid
  }
}

# Get all tournaments (admin script only)
query GetAllTournaments
  @auth(level: PUBLIC, insecureReason: "Admin cleanup script - read-only list operation") {
  tournaments(orderBy: { createdAt: DESC }) {
    id
    fplLeagueId
    fplLeagueName
    participantCount
    status
    createdAt
  }
}

# =============================================================================
# ROUND QUERIES
# =============================================================================

# Get rounds for a tournament
query GetTournamentRounds($tournamentId: UUID!) @auth(level: PUBLIC) {
  rounds(where: { tournamentId: { eq: $tournamentId } }, orderBy: { roundNumber: ASC }) {
    tournamentId
    roundNumber
    event
    status
    startedAt
    completedAt
  }
}

# Get a specific round
query GetRound($tournamentId: UUID!, $roundNumber: Int!) @auth(level: PUBLIC) {
  rounds(where: { tournamentId: { eq: $tournamentId }, roundNumber: { eq: $roundNumber } }, limit: 1) {
    tournamentId
    roundNumber
    event
    status
    startedAt
    completedAt
  }
}

# Get active rounds (for scheduled function)
query GetActiveRounds($event: Int!) @auth(level: PUBLIC) {
  rounds(where: { event: { eq: $event }, status: { eq: "active" } }) {
    tournamentId
    roundNumber
    event
    status
    tournament {
      id
      fplLeagueName
      currentRound
    }
  }
}

# Get pending active rounds for any finished gameweek (catch-up mode)
query GetPendingActiveRounds($maxEvent: Int!) @auth(level: PUBLIC) {
  rounds(
    where: {
      status: { eq: "active" }
      event: { le: $maxEvent }
    }
    orderBy: { event: ASC }
  ) {
    tournamentId
    roundNumber
    event
    status
    updatedAt
    tournament {
      id
      fplLeagueId
      fplLeagueName
      totalRounds
      status
    }
  }
}

# =============================================================================
# MATCH QUERIES
# =============================================================================

# Get matches for a round
query GetRoundMatches($tournamentId: UUID!, $roundNumber: Int!) @auth(level: PUBLIC) {
  matches(
    where: { tournamentId: { eq: $tournamentId }, roundNumber: { eq: $roundNumber } }
    orderBy: { positionInRound: ASC }
  ) {
    tournamentId
    matchId
    roundNumber
    positionInRound
    status
    winnerEntryId
    isBye
    completedAt
    qualifiesToMatchId
  }
}

# Get matches in a position range for paginated bracket view
# Used to show 8-4-2-1 match windows (15 matches total)
query GetMatchesInRange(
  $tournamentId: UUID!
  $roundNumber: Int!
  $startPosition: Int!
  $endPosition: Int!
) @auth(level: PUBLIC) {
  matches(
    where: {
      tournamentId: { eq: $tournamentId }
      roundNumber: { eq: $roundNumber }
      positionInRound: { ge: $startPosition, le: $endPosition }
    }
    orderBy: { positionInRound: ASC }
  ) {
    matchId
    roundNumber
    positionInRound
    status
    winnerEntryId
    isBye
    qualifiesToMatchId
    matchPicks_on_match {
      entryId
      slot
      participant {
        seed
        teamName
        managerName
      }
    }
  }
}

# Get single match
query GetMatch($tournamentId: UUID!, $matchId: Int!) @auth(level: PUBLIC) {
  matches(where: { tournamentId: { eq: $tournamentId }, matchId: { eq: $matchId } }, limit: 1) {
    tournamentId
    matchId
    roundNumber
    positionInRound
    status
    winnerEntryId
    isBye
    completedAt
    qualifiesToMatchId
    tournament {
      fplLeagueName
      currentRound
    }
  }
}

# Get match picks (players in a match)
query GetMatchPicks($tournamentId: UUID!, $matchId: Int!) @auth(level: PUBLIC) {
  matchPicks(where: { tournamentId: { eq: $tournamentId }, matchId: { eq: $matchId } }, orderBy: { slot: ASC }) {
    tournamentId
    matchId
    entryId
    slot
    entry {
      entryId
      name
      playerFirstName
      playerLastName
    }
  }
}

# Get ALL match picks for a tournament (single query instead of N queries)
# This avoids rate limiting when loading large tournaments
# Limit increased to 500 to handle large tournaments (default is 100)
# Includes participant data for team name display (avoids separate participant lookup)
query GetAllTournamentMatchPicks($tournamentId: UUID!) @auth(level: PUBLIC) {
  matchPicks(where: { tournamentId: { eq: $tournamentId } }, orderBy: [{ matchId: ASC }, { slot: ASC }], limit: 500) {
    matchId
    entryId
    slot
    entry {
      entryId
      name
      playerFirstName
      playerLastName
    }
    participant {
      seed
      teamName
      managerName
    }
  }
}

# Find user's matches by entry
query GetUserMatches($entryId: Int!) @auth(level: PUBLIC) {
  matchPicks(where: { entryId: { eq: $entryId } }) {
    tournamentId
    matchId
    entryId
    slot
  }
}

# =============================================================================
# PARTICIPANT QUERIES
# =============================================================================

# Search participants by team name (for large tournament search)
query SearchParticipants(
  $tournamentId: UUID!
  $searchTerm: String!
  $limit: Int = 20
) @auth(level: PUBLIC) {
  participants(
    where: {
      tournamentId: { eq: $tournamentId }
      teamName: { contains: $searchTerm }
    }
    orderBy: { seed: ASC }
    limit: $limit
  ) {
    entryId
    teamName
    managerName
    seed
    status
  }
}

# Get participant
query GetParticipant($tournamentId: UUID!, $entryId: Int!) @auth(level: PUBLIC) {
  participants(where: { tournamentId: { eq: $tournamentId }, entryId: { eq: $entryId } }, limit: 1) {
    tournamentId
    entryId
    teamName
    managerName
    seed
    leagueRank
    leaguePoints
    status
    eliminationRound
    uid
    rawJson
  }
}

# Get active participants in a tournament
query GetActiveParticipants($tournamentId: UUID!) @auth(level: PUBLIC) {
  participants(
    where: { tournamentId: { eq: $tournamentId }, status: { eq: "active" } }
    orderBy: { seed: ASC }
  ) {
    tournamentId
    entryId
    teamName
    managerName
    seed
    leagueRank
    status
  }
}

# Get user's tournament participations
query GetUserParticipations($uid: String!) @auth(level: USER) {
  participants(where: { uid: { eq: $uid } }) {
    tournamentId
    entryId
    teamName
    seed
    status
    eliminationRound
    tournament {
      id
      fplLeagueName
      status
      currentRound
    }
  }
}

# =============================================================================
# EMAIL QUEUE QUERIES
# =============================================================================

# Get rounds for a specific gameweek (for finding users with matches)
# Used to find users who may need verdict emails
# Note: Participants are queried separately since Tournament doesn't have direct participants relation
query GetRoundsInEvent($event: Int!) @auth(level: PUBLIC) {
  rounds(where: { event: { eq: $event } }) {
    tournamentId
    roundNumber
    event
  }
}

# Get participants for a tournament with their user data
# Used in combination with GetRoundsInEvent to find users needing verdict emails
query GetTournamentParticipantsWithUsers($tournamentId: UUID!) @auth(level: PUBLIC) {
  participants(where: { tournamentId: { eq: $tournamentId }, uid: { isNull: false } }) {
    tournamentId
    uid
    entryId
    teamName
    user {
      uid
      email
    }
  }
}

# Check if user already has email queued for this event
query GetExistingEmailQueue(
  $userUid: String!
  $type: String!
  $event: Int!
) @auth(level: PUBLIC) {
  emailQueues(
    where: {
      userUid: { eq: $userUid }
      type: { eq: $type }
      event: { eq: $event }
    }
    limit: 1
  ) {
    id
    status
  }
}

# Get all match picks for a specific entry
# Note: Match doesn't have a round relation, so we get roundNumber and filter by event via rounds query
query GetEntryMatchPicks($entryId: Int!) @auth(level: PUBLIC) {
  matchPicks(where: { entryId: { eq: $entryId } }) {
    tournamentId
    matchId
    entryId
    slot
    match {
      matchId
      roundNumber
      status
      winnerEntryId
      updatedAt
      isBye
    }
  }
}

# =============================================================================
# VERDICT EMAIL QUERIES
# =============================================================================

# Get user's matches in a specific tournament with full details
# Used for "Your Matches" section - includes opponent data via matchPicks_on_match
# Note: Round event must be fetched separately via GetTournamentRounds
query GetUserTournamentMatches(
  $tournamentId: UUID!
  $entryId: Int!
) @auth(level: PUBLIC) {
  matchPicks(
    where: {
      tournamentId: { eq: $tournamentId }
      entryId: { eq: $entryId }
    }
    orderBy: { matchId: ASC }
  ) {
    matchId
    entryId
    slot
    participant {
      entryId
      teamName
      managerName
      seed
      status
    }
    match {
      matchId
      roundNumber
      positionInRound
      status
      winnerEntryId
      isBye
      matchPicks_on_match {
        entryId
        slot
        participant {
          entryId
          teamName
          managerName
          seed
        }
      }
    }
  }
}

# Get all match results for a user
# Includes match data needed to build verdict email content
# Note: Match doesn't have round relation, so we get roundNumber and cross-reference with rounds
# Note: Match doesn't have matchPicks relation, so opponent data must be fetched separately
query GetUserVerdictMatchPicks($entryId: Int!) @auth(level: PUBLIC) {
  matchPicks(where: { entryId: { eq: $entryId } }) {
    tournamentId
    matchId
    entryId
    slot
    match {
      matchId
      roundNumber
      status
      winnerEntryId
      isBye
      positionInRound
      tournament {
        id
        fplLeagueName
        totalRounds
      }
    }
    participant {
      entryId
      teamName
      seed
    }
  }
}

# Get all match picks for a specific match (to find opponents)
query GetMatchParticipants($tournamentId: UUID!, $matchId: Int!) @auth(level: PUBLIC) {
  matchPicks(where: { tournamentId: { eq: $tournamentId }, matchId: { eq: $matchId } }) {
    entryId
    slot
    participant {
      entryId
      teamName
      seed
    }
  }
}

# Get scores for multiple entries in a specific event
query GetPickScores($entryIds: [Int!]!, $event: Int!) @auth(level: PUBLIC) {
  picks(where: { entryId: { in: $entryIds }, event: { eq: $event } }) {
    entryId
    event
    points
  }
}

# =============================================================================
# BRACKET UPDATE QUERIES
# =============================================================================

# Get matches for a round with claimed user priority ordering
# Returns matches where participants may have claimed (has uid)
# Sorting by claimed status happens in TypeScript code
query GetRoundMatchesWithPriority(
  $tournamentId: UUID!,
  $roundNumber: Int!
) @auth(level: PUBLIC) {
  matches(
    where: {
      tournamentId: { eq: $tournamentId }
      roundNumber: { eq: $roundNumber }
      status: { ne: "complete" }
      isBye: { eq: false }
    }
    orderBy: { positionInRound: ASC }
  ) {
    matchId
    roundNumber
    positionInRound
    status
    winnerEntryId
    qualifiesToMatchId
    matchPicks_on_match {
      entryId
      slot
      participant {
        seed
        uid
        teamName
        managerName
      }
    }
  }
}

# =============================================================================
# USER PATH BRACKET QUERIES
# =============================================================================

# Get match histories for multiple opponents in a tournament
# Used to show how opponents reached their current position
query GetOpponentMatchHistories(
  $tournamentId: UUID!
  $entryIds: [Int!]!
) @auth(level: PUBLIC) {
  matchPicks(
    where: {
      tournamentId: { eq: $tournamentId }
      entryId: { in: $entryIds }
    }
    orderBy: [{ entryId: ASC }, { matchId: ASC }]
  ) {
    entryId
    slot
    match {
      matchId
      roundNumber
      positionInRound
      status
      winnerEntryId
      isBye
      matchPicks_on_match {
        entryId
        slot
        participant {
          entryId
          teamName
          managerName
          seed
        }
      }
    }
  }
}

# Get highest seed still active in tournament (for spectator default view)
query GetHighestSeedRemaining(
  $tournamentId: UUID!
) @auth(level: PUBLIC) {
  participants(
    where: {
      tournamentId: { eq: $tournamentId }
      status: { eq: "active" }
    }
    orderBy: { seed: ASC }
    limit: 1
  ) {
    entryId
    teamName
    managerName
    seed
  }
}

# =============================================================================
# IMPORT STATUS QUERIES
# =============================================================================

# Get tournament import status for polling during large tournament creation
query GetTournamentImportStatus($id: UUID!) @auth(level: PUBLIC) {
  tournament(id: $id) {
    id
    importStatus
    importProgress
    importedCount
    totalCount
    importError
  }
}

# =============================================================================
# PARTICIPANT LEAGUE QUERIES (Friends Feature)
# =============================================================================

# Get all participant league memberships for a tournament
# Used to calculate "friends" - participants sharing leagues with the user
query GetParticipantLeaguesForTournament($tournamentId: UUID!) @auth(level: PUBLIC) {
  participantLeagues(where: { tournamentId: { eq: $tournamentId } }) {
    tournamentId
    entryId
    leagueId
    leagueName
    entryRank
  }
}
